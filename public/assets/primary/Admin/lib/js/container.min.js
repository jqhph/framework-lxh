window.Lxh=function(options){function Container(options){var self=this,config,cache,store,user,language,view,ui,env,tpl,util,urlMaker,iframe,tab;function init(){config=new Store(options.config||{});util=new Util();cache=options.cache;store=new Store();user=new Store(options.users||{});language=new Language(self,cache,config);ui=new UI();env=new Env();tpl=new Tpl(self,cache,config);view=new View(self,tpl);iframe=new Iframe(self);tab=new Tab(iframe);urlMaker=new UrlMaker(self)}this.parentDocument=function(){if(typeof window.parent!='undefined'&&typeof window.parent.document!='undefined'){return window.parent.document}return document};this.controllerName=function(){return options.controller};this.moduleName=function(){return options.module};this.actionName=function(){return options.action};this.requestParams=function(){return options.params};this.config=function(){return config};this.cache=function(){return cache};this.store=function(){return store};this.user=function(){return user};this.language=function(){return language};this.view=function(){return view};this.ui=function(){return ui};this.env=function(){return env};this.tpl=function(){return tpl};this.util=function(){return util};this.url=function(){return urlMaker};this.iframe=function(){return iframe};this.tab=function(){return tab};init()}Container.prototype={statusCode:{success:10001,failed:10002,invalid_arguments:10003},setStatusCode:function(o){this.statusCode=o},set:function(name,val){this.store().set(name,val);return this},get:function(name,$def){return this.store().get(name,$def)},redirect:function(routePath,timeout){if(!timeout){return window.location=routePath}setTimeout(function(){window.location=routePath},timeout)},createModel:function(name,module){name=name||this.controllerName();return new Model(name,module,this)},createStore:function(data){return new Store(data)},form:function(){return this.get('form')||this.set('form',new Form()).get('form')},validator:function(options,call,selector){return validator(options,call,selector)}};function Tab(iframe){var $top=parent.$top||'';this.switch=function(name){$top.tab.switch(name)};this.show=function(name){$top.tab.show(name)};this.open=function(name,url,label){$top.tab.open(name,url,label)};this.close=function($this){$top.tab.close($this)};this.removeActive=function(){$top.tab.removeActive(name)};function init(){$top&&$top.iframe.height($('#wrapper-home iframe',window.parent.document));var $thisTab=$('[data-action="tab-home"]',window.parent.document);$thisTab.click(function(){$top&&$top.tab.switch('home')});$thisTab.find('.tab-close').click(function(){$top&&$top.tab.close('home')});$('[data-action="switch-menu"]').click(function(){var $this=$(this),id=$this.data('id'),url=$this.data('url'),label=$this.data('name');if(!url)return false;$top&&$top.tab.open(id,url,label)})}init()}function Iframe(container){var $top=parent.$top||'';this.switch=function(name){$top.iframe.switch(name)};this.current=function(){return $top.iframe.current()};this.remove=function(name){$top.iframe.remove(name)};this.create=function(name,url){$top.iframe.create(name)};this.height=function($this){$top.iframe.height($this)};this.currentHeight=function(){var $this=$('#wrapper-'+$top.iframe.current()+' iframe',window.parent.document);$top.iframe.height($this)};this.hide=function(){$top.iframe.hide(name)}}function Util(){return{trim:function(str,symbol){symbol=symbol||"\\s";var reg=new RegExp('(^'+symbol+'*)|('+symbol+'*$)','g');return str.replace(reg,"")},cmp:function(x,y){if(x===y){return true}if(!(x instanceof Object)||!(y instanceof Object)){return false}if(x.constructor!==y.constructor){return false}for(var p in x){if(x.hasOwnProperty(p)){if(!y.hasOwnProperty(p)){return false}if(x[p]===y[p]){continue}if(typeof(x[p])!=="object"){return false}if(!this.cmp(x[p],y[p])){return false}}}for(p in y){if(y.hasOwnProperty(p)&&!x.hasOwnProperty(p)){return false}}return true}}}function UrlMaker(container){var store={prefix:'/admin'};return{makeAction:function(a,c){a=a||container.actionName();c=c||container.controllerName();return store.prefix+'/'+to_under_score(c)+'/'+to_under_score(a)},makeHome:function(){return store.prefix}}}function UI(){return{loading:function(selector,timeout){selector=selector||'.loading';if(timeout===false){return close(selector)}return show(selector,timeout);function show(selector,timeout){var $portlet=$(selector).closest(selector);$portlet.append('<div class="panel-disabled"><div class="loader-1"></div></div>');if(!timeout)return;setTimeout(function(){close(selector)},timeout)}function close(selector){var $pd=$(selector).closest(selector).find('.panel-disabled');$pd.fadeOut('fast',$pd.remove)}},notify:function(options){options=options||{};options.closeButton=options.closeButton||true;options.positionClass=options.positionClass||'toast-top-right';options.showMethod=options.showMethod||'slideDown';var toastr=window.toastr||window.top.toastr;toastr.options=options;return toastr},modal:function(options,call){options=options||{};options.closeButton=options.closeButton||true;options.class=options.class||'modal-container';options.title=trans(options.title)||'';options.content=options.content||'';options.saveButton=options.saveButton||true;options.saveButtonClass=options.saveButtonClass||'btn-primary';options.buttons=options.buttons||{};options.closeButtonLabel=trans(options.closeButtonLabel)||trans('Close');options.saveButtonLabel=trans(options.saveButtonLabel)||trans('Save');options.tpl=options.tpl||$('#modal-basic').text();var blade=new Blade(options.tpl,options);var $container=$('div.'+options.class);if($container.length>0){return $container.modal()}$('body').append(blade.fetch());$container=$('div.'+options.class);$container.find('button[data-action="modal-basic-close"]').click(close);var modal=$container.modal();if(call){$container.find('button[data-action="modal-basic-save"]').click(function(){call(modal)})}modal.close=close;return modal;function close(){$('.modal-backdrop').remove();$container.remove();$('body').removeClass('modal-open')}}}}function View(container,tpl){var store={tpl:tpl};this.create=function(viewname,options){return this};this.then=function(callback){};this.call=function(deps,callback){seajs.use(deps,function(){var view=callback.call(arguments)})}}function Env(){return{val:'dev',set:function(type){this.val=type},isProd:function(){return this.val=='prod'},isDev:function(){return this.val=='dev'},isTest:function(){return this.val=='test'}}}function validator(options,call,selector){selector=selector||('.'+window.$lxh.controllerName()+'-form');var self=this;$(selector).submit(function(){return false});var $form=document.querySelector(selector);var v=new FormValidator($form,options,function(errors,event){if(errors.length<1&&(event==='submit'||event.type=='submit')){typeof call!='function'||call(event)}},validate_call);v.selector=selector;register_rules(v);add_events(options);function add_events(options){for(var key in options){if(options.hasOwnProperty(key)){var field=options[key]||{},element=$form[field.name];if(element&&element!==undefined){element.onfocus=element.onkeyup=function(e){v._validateForm(e)}}}}}function validate_call(field,errorObject){var $e=$(field.element);remove_error($e,field.name);if(errorObject){display_error_msg(field.name,$e,errorObject.message)}}function display_error_msg(name,e,msg){e=e.eq(0);name=name.replace('[]','');msg=trans(msg);e.addClass('parsley-error');e.parent().parent().prepend('<ul class="parsley-errors-list filled validator-error-'+name+'"><li class="parsley-required">'+msg+'</li></ul>')}function remove_error($e,name){name=name.replace('[]','');$e.removeClass('parsley-error');$('.validator-error-'+name).remove()}function register_rules(validator){}return v}function Tpl(container,cache,config){var store={},expireTime=config.get('cache-expire'),cacheKey='tpls',useCache=config.get('use-cache'),defaultScope=container.controllerName();var fill=this.fill=function(packages,save){if(!packages){packages=cache.get(cacheKey,{});save=false}for(var tplname in packages){store[tplname]=packages[tplname]}if(save){this.save(packages)}};this.save=function(packages){if(!useCache){return}var cachePackage={},i;cachePackage=cache.get(cacheKey,{});for(var tplname in packages){cachePackage[tplname]=packages[tplname]}cache.set(cacheKey,cachePackage);cache.expire(cacheKey,expireTime)};this.fetch=function(names,call){names=typeof names=='string'?[names]:names;if(useCache){var packages={};packages=cache.get(cacheKey);fill(packages)}var missingNames=[];for(var i in names){if(!store[names[i]]){missingNames.push(names[i])}}if(missingNames.length<1){return call(store)}var model=container.createModel('Tpl');model.data({names:missingNames.join(',')});model.on('success',function(data){fill(data.list,true);call(store)});model.touchAction('get','POST')};this.all=function(){return store};this.get=function(name){return store[name]||null};this.module=function(name){return store[defaultScope+'.'+name]||null};this.component=function(name){return store['component.'+name]||null};this.fields=function(name){return store['component.fields.'+name]||null}}function Language(container,cache,config){var store={},lang=config.get('language'),defaultScope=container.controllerName(),self=this,cacheKeyPrefix='language_',cacheKey=cacheKeyPrefix+lang,useCache=config.get('use-cache'),expireTime=config.get('lang-package-expire');store[lang]=new Store();var fill=this.fill=function(packages,save){if(!packages){packages={};packages[lang]=cache.get(cacheKey);save=false}for(var language in packages){if(!store[language]){store[language]=new Store()}for(var scope in packages[language]){store[language].set(scope,packages[language][scope])}}if(save){this.save(packages)}};this.save=function(packages){if(!useCache){return}var cachePackage={},i,key;for(var lang in packages){key=cacheKeyPrefix+lang;cachePackage=cache.get(key,{});for(i in packages[lang]){cachePackage[i]=packages[lang][i]}cache.set(key,cachePackage);cache.expire(key,expireTime)}};this.fetch=function(scopes,call){scopes=typeof scopes=='string'?[scopes]:scopes;if(useCache){var packages={};packages[lang]=cache.get(cacheKey);fill(packages)}var missingScopes=[];for(var i in scopes){if(!store[lang].get(scopes[i])){missingScopes.push(scopes[i])}}if(missingScopes.length<1){return call()}var model=container.createModel('Language');model.data({lang:lang,scopes:missingScopes.join(',')});model.on('success',function(data){fill(data.list,true);call()});model.touchAction('get','POST')};window.trans=this.trans=function(label,category,scope){category=category||'labels';scope=scope||defaultScope;var res=store[lang].get(scope+'.'+category+'.'+label);return res||store[lang].get('Global.'+category+'.'+label,label)};window.trans_option=this.transOption=function(value,label,scope){scope=scope||defaultScope;var res=store[lang].get(scope+'.options.'+label+'.'+value);return res||store[lang].get('Global.options.'+label+'.'+value,value)};this.type=function(type){lang=type;store[lang]||(store[lang]=new Store())};this.all=function(language){return store[language||lang].all()}}function Model(name,module,container){var notify=container.ui().notify(),globalUtil=container.util();var store={isRequsting:false,attrs:{},initialData:{},module:'Admin',name:'',api:'',timeout:10000,responseContent:{},formSelector:'',apiPrefix:'/api/',method:'POST',formHandler:null,data:null,call:{success:function(data){},failed:function(data){if(typeof swal!='undefined')swal.close();notify.remove();notify.error(trans(data.msg,'tip'))},error:function(req,msg,e){notify.remove();notify.error(req.status+' '+trans(req.statusText)+' '+trans(req.responseText));},any:function(){}}};store.formHandler=container.form();store.name=name;store.initialData=store.formHandler.get(get_form_selector());this.set=function(k,v){if(typeof k=='object'){store.attrs=k}else{store.attrs[k]=v}return this};this.unset=function(k){delete store.attrs[k];return this};this.timeout=function(m){store.timeout=m;return this};this.reset=function(){store.attrs={};return this};this.get=function(k,def){return store.attrs[k]||def};this.all=function(){return store.attrs};this.data=function(data){store.data=data;return this};this.on=function(name,call){if(typeof call!='function')throw new Error('Invalid arguments.');store.call[name]=call||store.call[name];return this};this.requestEnded=function(){return(!store.isRequsting)};this.request=function(api,method){store.method=method||store.method;store.api=api||store.api;if(!this.requestEnded()){return}store.isRequsting=true;var data=util.getData();console.log('request data',data);if(store.method.toLocaleUpperCase()=='PUT'){data=JSON.stringify(data)}$.ajax({url:store.api,ifModified:false,type:store.method,cache:true,async:true,data:data,timeout:store.timeout,success:function(data){store.isRequsting=false;if(typeof data!='object'&&data.indexOf('{')==0)data=JSON.parse(data);store.responseContent[store.method+store.api]=data;if(data.status){if(data.status==container.statusCode.success){store.call.success(data)}else{store.call.failed(data)}}else{store.call.success(data)}store.call.any(data)},error:function(req,msg,e){store.isRequsting=false;store.call.error(req,msg,e)}})};this.touchAction=function(action,method){return this.request(util.parseApi('action',{action:action}),method)};this.add=function(){return this.request(util.parseApi('add'),'POST')};this.edit=function(){if(container.util().cmp(store.initialData,store.formHandler.get(get_form_selector()))===true){notify.remove();return notify.info(trans('Nothing has been change.'))}return this.request(util.parseApi('edit'),'PUT')};this.save=function(){var data=store.formHandler.get(get_form_selector());if(data.id){return this.edit()}return this.add()};this.delete=function(){return this.request(util.parseApi('delete'),'DELETE')};this.fetchList=function(){return this.request(util.parseApi('list'),'GET')};this.fetchRow=function(){return this.request(util.parseApi('detail'),'GET')};this.getFormData=function(){return store.formHandler.get(get_form_selector())};var self=this;var util={getData:function(){var data=store.data;if(data){store.data=null;return data}data=store.formHandler.get(get_form_selector());for(var i in data){self.set(i,data[i])}return self.all()},parseApi:function(type,options){var scopeName=this.normalizeRequestName(store.name);switch(type){case'add':return store.apiPrefix+scopeName;case'edit':var id=self.get('id')||store.formHandler.get(get_form_selector()).id;return store.apiPrefix+scopeName+'/view/'+id;case'delete':var id=self.get('id');return store.apiPrefix+scopeName+'/view/'+id;case'list':return store.apiPrefix+scopeName+'/list';case'detail':return store.apiPrefix+scopeName+'/view/'+self.get('id');case'action':return store.apiPrefix+scopeName+'/'+this.normalizeRequestName(options.action)}},normalizeRequestName:function(name){return globalUtil.trim(name.replace(/([A-Z])/g,function(full,$match){return'-'+$match.toLocaleLowerCase()}),'-')}};this.selector=function(){return get_form_selector()};function get_form_selector(){return store.formSelector||(store.formSelector='.'+store.name+'-form')}}function Form(){var formEles=['input','textarea','select'];function get_elements(selector){var form=document.querySelector(selector);if(!form)return[];var elements=[],tagElements;for(var i in formEles){tagElements=form.getElementsByTagName(formEles[i]);for(var j=0;j<tagElements.length;j++){elements.push(tagElements[j])}}return elements}function input_selector(element){if(element.checked){return[element.name,element.value]}return[element.name,'']}function input(element){switch(element.type.toLowerCase()){case'checkbox':case'radio':return input_selector(element);default:return[element.name,element.value]}return false}function serialize_element(element){return input(element)}this.get=function(selector){var elements=get_elements(selector);var data={};for(var i=0;i<elements.length;i++){var component=serialize_element(elements[i]);if(!component||typeof component[1]=='undefined')continue;if(component[0].indexOf('[')!==-1&&component[0].indexOf(']')!==-1){component[0]=component[0].replace('[]','');if(typeof data[component[0]]=='undefined'){data[component[0]]=[]}data[component[0]].push(component[1])}else{data[component[0]]=component[1]}}return data}}function Store(data){data=data||{};this.all=function(){return data};this.toJson=function(){return JSON.stringify(data)};this.get=function($key,$default){if(!$key){return data}$default=$default||null;var $lastItem=data,keys=$key.split('.');for(var i=0;i<keys.length;i++){if(typeof $lastItem[keys[i]]!='undefined'){$lastItem=$lastItem[keys[i]]}else{return $default}}return $lastItem};this.set=function(key,val){if(typeof key=='object'){data=key}else{data[key]=val}};this.add=function(key,name,val){data[key]=data[key]||{};data[key][name]=val};this.push=function(key,val){data[key]=data[key]||[];data[key].push(val)};this.pushSub=function(key,name,val){data[key]=data[key]||{};data[key][name]=data[key][name]||[];data[key][name].push(val)}}return new Container(options)};