/**
 * 初始化js
 *
 * Created by Jqh on 2017/7/3.
 */
// blade js
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('1t.1v={1T:"1.0-1Z",R:{},1X:5(a,b){3(I b!="5"){N H Q("1W 1V")}F.R[a]=b}};1t.1v={1T:"1.0-1Z",R:{},1X:5(a,b){3(I b!="5"){N H Q("1W 1V")}F.R[a]=b}};1t.2g=5(m,n){4 p={1h:"#26",18:12,1a:m,M:{},1x:{1R:"{",K:"}"},D:{$3:"@3",$7:"@7",$O:"@O",$Y:"@Y",$L:"@L",$X:"@X",$K:"@",$1j:{1l:"#1l"},$R:{}},J:{$4:/{([a-z|G]*[0-9]*[G]*[\\.]*([a-z|G]*[0-9]*[G]*)+([\\[]?([a-z|G]*[0-9]*[G]*[\\.]*([a-z|G]*[0-9]*[G]*)+)[\\]]?))}/E,1Q:/[\\[]([a-z|G]*[0-9]*[G]*[\\.]*([a-z|G]*[0-9]*[G]*)+)[\\]]/E,1N:/[ ]([\\\'|\\"]*[\\[G\\.\\]a-z]+[0-9\\]]*[\\\'|\\"]*)+/E,1L:/[ ]+((?![\\\'|\\"])[\\[G\\.\\]a-z]+[0-9\\]]*)+[ ]*/E,$3:/@3[ ]+([\\s\\S.])+@Y\\b/E,$L:/@L[ ]+([\\s\\S.])+@X\\b/E,22:/{(#[^{|{#]+)}/E,1D:/#[a-z]*\\b/i,1I:/{(#[^{|{#]+)#}/E,"@3":/@3\\b/E,"@Y":/@Y\\b/E,"@O":/@O\\b/E,"@7":/@7\\b/E,"@L":/@L\\b/E,"@X":/@X\\b/E,},1J:{$3:"\\n 3 ({13}) { \\n {P} \\n } \\n",$O:" 7 3 ({13}) { \\n {P} \\n } \\n",$7:" 7 { \\n {P} \\n } \\n"}};p.1a=m;p.M=n||{};p.D.$R=1v.R;4 r=F;F.2f=5(){6 p.M};F.2h=5(){6 p.1a};F.1K=5(a){p.M=a||p.M;1H(p.1a);6 A(u(w(z(y(p.1a)))))};F.1U=5(a,b){p.1h=a||p.1h;p.18=b||p.18;28.2d(p.1h).2e=F.1K();I p.18!="5"||p.18(F)};F.2j=5(a){p.M=a||p.M;F.1U()};F.1u=5(a,b){3(I a=="1g"){p.M=a}7{p.M[a]=b}};4 u=5(f){6 f.8(p.J.1I,5(a,b,c){4 e=b.1b(p.J.1D),d,i,j,o,t,q;b=b.8(e[0],"");e=e[0].8("#","");10(i 1f p.D.$R){3(i!=e){1d}d=1q(x.1s(b,1r,"!!"));d=d.1p("!!");t=[];t.11(r);10(j 1f d){3(I d[j]=="5"){1d}3(v(d[j])){d[j]=1n.24(1q(d[j]));t.11(d[j])}7{d[j]=d[j].8(/\'|"/g,"");3(I d[j]!="5"){t.11(1q(d[j]))}}}6 p.D.$R[i].27(r,t)}6 a})};4 v=5(d){3((d.V("{")===0&&d.V("}")!=-1)||(d.V("[")===0&&d.V("]")!=-1)){6 W}6 1r};4 w=5(e){3(!e){6""}6 e.8(p.J.22,5(a,b,c){4 d=b.1b(p.J.1D);d=d[0];10(4 i 1f p.D.$1j){3(d==p.D.$1j[i]){6 x[i](b.8(d,""))}}6 a})};4 x={1l:5(a){4 b=F.1z(a,"??",2);4 c=F.1z(b[1],"::",1);4 d="{";10(4 i 1f c){3(I c[i]=="5"){1d}3(i==1){d+="} 7 {"}3(c[i].V("\'")!=-1||c[i].V(\'"\')!=-1){d+=" 4 1A = "+c[i]}7{d+=" 4 1A = "+F.1s(c[i],W)}}d="3 ("+F.1O(b[0],W)+") "+d+"}";1M(d);6 1A||""},1s:5(c,Z,f){f=f||" ";4 i=0,d,s=f,e=f;6 c.8(p.J.1N,5(a,b){d=B(b,12,Z);i++;3(i==1){s=""}6(I d=="1g"?s+1n.1E(d)+e:s+d+e)})},1O:5(c,Z,e){e=e||" ";6 c.8(p.J.1L,5(a,b){4 d=B(b,12,Z);6(I d=="1g"?e+1n.1E(d)+e:e+d+e)})},1z:5(a,b,c){a=a.1p(b);3(a.1e<c){N H Q(\'1G 1F: "\'+p.D.$1j.1l+\'" 1S 29 2a 2b\')}6 a}};4 y=5(g){6 g.8(p.J.$L,5(a,b,c){4 d=1c("L","X",a,W,W);4 e=d.13.1p(" "),14=[];10(4 i=0;i<e.1e;i++){3(!e[i]||e[i]=="\\n"){1d}14.11(e[i].8(/[\\s\\n]/E,""))}4 f="",U=[],15=12,1C,i,16,1B=1r;U=14.1P();U=1k(U);U=C(U)||[];3(14.1e>1){15=14.1P()}1C=14.25();10(i 1f U){3(I U[i]=="5"){1d}16=d.P;3(15){r.1u(1k(15),i)}r.1u(1k(1C),U[i]);3(1B||1y("L",16)){1B=W;16=y(16)}f+=A(u(w(z(16))))}6 f})};4 z=5(k,l){6 k.8(p.J.$3,5(a,b,c){4 d=1c("3","K",a);a=d.17;4 e=[];e.11(d.P);4 f=1o("3",d,0);4 g=T("O",a);10(4 i=1;i<=g;i++){4 h=1c("O","K",a);a=h.17;e.11(h.P);f+=1o("O",h,i)}4 j=T("7",a);3(j){h=1c("7","K",a);3(h.17){a=h.17.8("7","")}e.11(h.P);f+=1o("7",h,i)}1M(f);3(a){a=a.8(p.D.$Y,"")}6(A(u(w(e[15])))||"")+a})};4 A=5(d,e,Z,f){3(!d){6 12}6 d.8(p.J.$4,5(a,b,c){6 B(b,e,Z,f)})};4 B=5(b,c,Z,d){3(b.V("[")==-1){3(Z){4 t=C(b,c,d);3(I t=="1g"){6 1n.1E(t)}7{3(I t=="2c"){6 t}}6\'"\'+t+\'"\'}6 C(b,c,d)}7{6 C(b.8(p.J.1Q,5(f,a){6"."+C(a,c,d)}),d)}};4 C=5(a,b,c){4 d=b||p.M,1i=a.1p(".");10(4 i=0;i<1i.1e;i++){3(I d[1i[i]]!="1Y"){d=d[1i[i]]}7{6(I c!="1Y")?c:a}}6 d};5 1H(a){4 b="1G 1F: ";4 c=T("3",a),1w=T("Y",a);3(c>1w){N H Q(b+\'19 "\'+p.D.$Y+\'"\')}7{3(c<1w){N H Q(b+\'19 "\'+p.D.$3+\'"\')}}4 d=T("7",a);3(d>c){N H Q(b+\'20 "\'+p.D.$7+\'" 21\')}4 e=T("O",a);3(c==0&&e>0){N H Q(b+\'20 "\'+p.D.$O+\'" 21\')}4 f=T("L",a);4 g=T("X",a);3(f>g){N H Q(b+\'19 "\'+p.D.$X+\'"\')}7{3(f<g){N H Q(b+\'19 "\'+p.D.$L+\'"\')}}}5 1k(a){6 a.8(H 1m("["+p.1x.1R+"|"+p.1x.K+"]","E"),"")}5 1o(a,b,i){4 c=A(b.13,12,W,"");4 d=p.1J["$"+a].8("{13}",c);6 d.8("{P}",\'4 15 = "\'+i+\'"\')}5 1y(a,b){3(b.V(p.D["$"+a])!=-1&&b.V(p.D["$K"+a])!=-1){6 W}6 1r}5 1c(a,b,c,d,e){4 f=p.D["$"+a],K=p.D["$"+b];4 g=c.1b(H 1m(f+"[ ]*([^@]*?)\\n","i"));3(!g||!g[0]){N H Q(\'1G 1F: "\'+f+\'" 19 1S P\')}c=c.8(g[0],"");3(e){3(K!="@"){4 h=c.2i(K);3(h!=-1){c=c.23(0,h)}7{c=c.8(K,"")}}}g=g[0].8(H 1m("(?:"+f+"[ ])*|\\n","E"),"");3(1y(a,c)){3(a=="3"){c=z(c)}}4 i="";3(d){i=c}7{i=c.1b(H 1m("([^"+K+"]*)","E"));i=i[0]}c=c.8(i,"");6{13:g,P:i,17:c}}5 T(a,b){4 t=b.1b(p.J[p.D["$"+a]]);3(!t){6 0}6 t.1e}5 1q(a){6 a.8(/(^\\s*)|(\\s*$)/g,"")}};',62,144,'|||if|var|function|return|else|replace|||||||||||||||||||||||||||||||placeholders|gi|this|_|new|typeof|regs|end|foreach|vars|throw|elseif|content|Error|customTags||get_length|list|indexOf|true|endforeach|endif|toString|for|push|null|exp|exps|key|foreachTpl|full|call|miss|tpl|match|get_exp_and_content|continue|length|in|object|selector|keys|tags|get_var_name|compare|RegExp|JSON|get_eval_string|split|trim|false|transVar|window|assign|BladeConfig|endifTimes|delimiter|has|compareSyntaxAnalysis|result|hasSubForeach|value|tagName|stringify|error|Syntax|syntax_analysis|customTag|model|fetch|compareJsvar|eval|jsvar|compareTransVar|shift|stringVar|start|expression|version|render|argument|Invalid|addTag|undefined|dev|redundant|placeholder|tag|substr|parse|pop|blade|apply|document|is|not|legal|boolean|querySelector|innerHTML|getVars|Blade|getTpl|lastIndexOf|rerender'.split('|'),0,{}));
(function (w) {
    var cache = LXHSTORE.cache,
        version = cache.getToken(),
        configs = LXHSTORE.loaderConfig,
        useCache = configs.save || false,
        lifetime = configs.lifetime || 8640000;

    function Loader(srcs, completed) {
        var queue = [],
            unstores = [],
        // 保证代码按顺序执行
            map = {};

        var loader = {
            add: function (src) {
                if (typeof src == 'object') {
                    for (var i in src) {
                        this.add(src[i]);
                    }
                    return this;
                }

                if (! src) return;
                if (src.indexOf('.css') == -1) {
                    src = src.indexOf('.js') == -1 ? (src+'.js') : src;
                }

                src = normalize_url(src);
                map[src] = '';
                queue.push(src);
                return this;
            },
            // 发起请求
            request: function () {
                var code, i;
                for (i in queue) {
                    if (queue[i].indexOf('.css') != -1) {
                        async_load_style(queue[i]);
                        continue;
                    }

                    if (useCache && saveable(queue[i]) && (code = cache.get(get_cache_key(queue[i])))) {
                        run(code);
                        is_completed(queue[i]);
                        continue;
                    }
                    $.ajax({
                        url : queue[i],
                        dataType: 'text',
                        ifModified: false,
                        success: function (code) {
                            map[this.url] = code;
                            // 判断队列所有内容是否加载完毕
                            is_completed(this.url);
                            // 保存到缓存
                            save(this.url, code);
                        }
                    });
                }
            },

            // 禁止本地存储的路径
            disableStorage: function (path) {
                if (!path) return this;
                if (typeof path == 'object') {
                    for (var i in path) {
                        this.disableStorage(path[i]);
                    }
                    return this;
                }

                unstores.push(get_path(path));
                return this;
            },

            completed: function (callback) {
                completed = callback;
                return this;
            }

        };

        loader.add(srcs);

        for (var i in loader) {
            this[i] = loader[i].bind(this);
        }

        /////////////////////////////////////////////////
        function saveable(path) {
            path = get_path(path);

            for (var i in unstores) {
                if (unstores[i] == path) return false;
            }
            return true;
        }

        function async_load_style(css) {
            //异步延迟加载样式
            var link = $('<link />');
            link.attr('href', css);
            link.attr('rel', 'stylesheet');
            link.load(function () {
                // 判断队列所有内容是否加载完毕
                is_completed(css);
            });
            link.appendTo($('head'));
        }

        // 保存到缓存
        function save(url, code) {
            if (! useCache || !saveable(url)) return;
            // 缓存
            var key = get_cache_key(url);

            cache.set(key, code);
            cache.expire(key, lifetime);
        }

        // 判断队列所有内容是否加载完毕
        function is_completed(url) {
            queue = array_remove(queue, url);
            if (queue.length < 1 && completed) {
                for (var i in map) {
                    run(map[i]);
                }

                // 加载完毕
                completed();
            }
        }

    }

    function run(code) {
        try {
            eval.call(w, code);
        } catch (e) {
            console.error('ERROR: ', e);
        }
    }

    function parse_alias(url) {
        url = url.split('?');

        if (typeof configs.alias[url[0]] != 'undefined') {
            url[0] = configs.alias[url[0]];
        }
        return url.join('?');
    }
    function parse_path(url) {
        url = url.split('/');

        if (typeof configs.paths[url[0]] != 'undefined') {
            url[0] = configs.paths[url[0]];
        }

        return url.join('/');
    }

    function get_cache_key(url) {
        return get_path(url).replace(/\//gi, '');
    }

    function get_path(url) {
        return url ? url.split('?')[0] : '';
    }

    // 获取正常的url
    function normalize_url(url) {
        url = parse_path(parse_alias(url));
        if (url.indexOf('?') == -1) {
            return url + '?_js&_=' + version
        }
        return url;
    }

    w.LxhLoader = Loader
})(window);
(function (window) {
    var config = __ini__(), $cache = LXHSTORE.cache, $d = $(document);

    dispatch();

    function dispatch() {
        var jsversion = config.options.settings['js-version'],
            cssversion = config.options.settings['css-version'];

        config.options.cache = $cache;

        // 加载css
        new LxhLoader(get_used_css(config.publicCss, cssversion)).request();

        var dataApi = '';
        if (config) {
            dataApi = config.options.dataApi
        }

        new LxhLoader(get_used_js(config.publicJs, jsversion), function () {
            setTimeout(init, 10);
        }).disableStorage(dataApi).request();
    }

    // 初始化完成，执行动作
    function call_actions() {
        for (var i in lxhActions) {
            if (typeof lxhActions[i] == 'function') {
                lxhActions[i].apply(this);
            }
        }
        $d.trigger('app.completed');
    }

    /**
     * 初始化
     */
    function init() {
        if (typeof Lxh == 'undefined') return $(call_actions);
        window.$lxh = new Lxh(config.options);

        var lang = $lxh.config().get('language');

        var serverOptions = $lxh.createStore({});
        if (typeof load_data == 'function') {
            serverOptions.set(load_data());
        }

        // 语言包设置
        $lxh.language().type(lang);
        // 注入语言包数据
        $lxh.language().fill(serverOptions.get('language') || null, true);

        // 生成table 展示隐藏字段功能按键
        $('[data-pattern]').each(function () {
            var $tableScrollWrapper = $(this);
            if (typeof $tableScrollWrapper.responsiveTable != 'undefined') {
                $tableScrollWrapper.responsiveTable($tableScrollWrapper.data());
            }
        });

        // 初始化完毕，加载钩子
        $(call_actions);
    }

    function get_lang_cache_key(lang) {
        return 'language_' + lang
    }

    /**
     * 检测缓存中是否存在语言包，返回需要加载的语言包模块
     *
     * @param lang
     * @param scopes
     * @param useCache
     * @returns {*}
     */
    function check_cache_language(lang, scopes, useCache) {
        var cacheKey = get_lang_cache_key(lang), package = $cache.get(cacheKey), t = [], i;

        if (typeof add_lang_scopes == 'function') {
            var addScopes = add_lang_scopes();
            for (i in addScopes) {
                scopes.push(addScopes[i]);
            }
        }

        if (! package || ! useCache) return scopes || [];
        for (i in scopes) {
            if (! package[scopes[i]]) t.push(scopes[i]);
        }
        return t || [];
    }

    /**
     * 处理需要加载的css数组
     *
     * @param publicCss
     * @param v
     * @returns {*}
     */
    function get_used_css(publicCss, v) {
        if (typeof cssLibArr != 'undefined') {
            cssLibArr = array_unique(cssLibArr);
            for (var i in cssLibArr) {
                publicCss.push(cssLibArr[i]);
            }
        }

        for (i in publicCss) {
            if (publicCss[i].indexOf('.css') == -1) {
                publicCss[i] += '.css'
            }
            publicCss[i] = publicCss[i] + '?v=' + v;
        }

        cssLibArr = [];
        return publicCss;
    }

    /**
     * 处理需要加载的js数组
     *
     * @param publicJs
     * @param version
     * @returns {*}
     */
    function get_used_js(publicJs, version) {
        if (typeof jsLibArr != 'undefined') {
            jsLibArr = array_unique(jsLibArr);
            for (var i in jsLibArr) {
                if (jsLibArr[i].indexOf('.js') == -1 && jsLibArr[i].indexOf('?') == -1) {
                    publicJs.push(jsLibArr[i] + '.js?v=' + version);
                } else {
                    publicJs.push(jsLibArr[i]);
                }
            }
        }
        jsLibArr = [];

        var scopes = check_cache_language(config.options.settings.language, config.langScopes, config.options.settings['use-cache']);
        var loads = {};

        // 判断是否需要载入语言包
        if (scopes.length > 0) {
            // publicJs.push('api/language?scopes=' + scopes.join(',') + '&lang=' + config.options.settings.language)
            loads.language = scopes.join(',');
        }

        var jsApi = get_load_data_js_api(loads);

        if (jsApi) {
            publicJs.unshift(jsApi);
        }

        return publicJs;

        function get_load_data_js_api(data) {
            var api = config.options.dataApi;

            var p = '';
            for (var i in data) {
                p += '&n[]=' + i + ':' + data[i];
            }

            if (p) {
                return api + '?' + p;
            }
            return ''
        }
    }
})(window);
