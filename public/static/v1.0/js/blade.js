function Blade(u,A){function p(a){return a.replace(new RegExp("["+b.delimiter.start+"|"+b.delimiter.end+"]","gi"),"")}function q(a,c,d){c=l(c.exp,null,!0,"");return b.model["$"+a].replace("{exp}",c).replace("{content}",'var key = "'+d+'"')}function v(a,c){return-1!=c.indexOf(b.placeholders["$"+a])&&-1!=c.indexOf(b.placeholders["$end"+a])?!0:!1}function m(a,c,d,e,f){var r=b.placeholders["$"+a],n=b.placeholders["$"+c];c=d.match(new RegExp(r+"[ ]*([^@]*?)\n","i"));if(!c||!c[0])throw Error('Syntax error: "'+r+'" miss expression content');d=d.replace(c[0],"");f&&"@"!=n&&(f=d.lastIndexOf(n),d=-1!=f?d.substr(0,f):d.replace(n,""));c=c[0].replace(new RegExp("(?:"+r+"[ ])*|\n","gi"),"");v(a,d)&&"if"==a&&(d=t(d,"test"));e?a=d:(a=d.match(new RegExp("([^"+n+"]*)","gi")),a=a[0]);d=d.replace(a,"");return{exp:c,content:a,full:d}}function g(a,c){return(a=c.match(new RegExp(a+"[s]*","gi")))?a.length:0}var b={selector:"#blade",call:null,tpl:u,vars:{},delimiter:{start:"{",end:"}"},placeholders:{$if:"@if",$else:"@else",$elseif:"@elseif",$endif:"@endif",$foreach:"@foreach",$endforeach:"@endforeach",$end:"@",$tags:{compare:"@compare"}},comparison:{},regs:{$var:/{([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]*[0-9]*[_]*)+([\[]?([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]*[0-9]*[_]*)+)[\]]?))}/gi,stringVar:/[\[]([a-z|_]*[0-9]*[_]*[\.]*([a-z|_]+[0-9]*[_]*)+)[\]]/gi,jsvar:/((?![\'|\"])[\[_\.\]a-z]+[0-9\]]*)+[ ]*/gi,$if:/@if[ ]+([\s\S.])+@endif\b/gi,$foreach:/@foreach[ ]+([\s\S.])+@endforeach\b/gi,tag:/{(@[^{|{#]+)}/gi,tagName:/@[a-z]*\b/i},model:{$if:"\n if ({exp}) { \n {content} \n } \n",$elseif:" else if ({exp}) { \n {content} \n } \n",$else:" else { \n {content} \n } \n"}};b.tpl=u;b.vars=A||{};var w=this;this.getTpl=function(){return b.tpl};this.fetch=function(a){b.vars=a||b.vars;var c=a=b.tpl,d=g(b.placeholders.$if,c),e=g(b.placeholders.$endif,c);if(d>e)throw Error('Syntax error: miss "'+b.placeholders.$endif+'"');if(d<e)throw Error('Syntax error: miss "'+b.placeholders.$if+'"');if(g(b.placeholders.$else,c)>d)throw Error('Syntax error: redundant "'+b.placeholders.$else+'" placeholder');e=g(b.placeholders.$elseif,c);if(0==d&&0<e)throw Error('Syntax error: redundant "'+b.placeholders.$elseif+'" placeholder');d=g(b.placeholders.$foreach,c);c=g(b.placeholders.$endforeach,c);if(d>c)throw Error('Syntax error: miss "'+b.placeholders.$endforeach+'"');if(d<c)throw Error('Syntax error: miss "'+b.placeholders.$foreach+'"');a=x(a);a=y(a);a=t(a);a="undefined"!=a?a:"";return l(a)};this.render=function(a,c){b.selector=a||b.selector;b.call=c||b.call;document.querySelector(b.selector).innerHTML=this.fetch();"function"!=typeof b.call||b.call(this)};this.rerender=function(a){b.vars=a||b.vars;this.render()};this.assign=function(a,c){"object"==typeof a?b.vars=a:b.vars[a]=c};var y=function(a){return a.replace(b.regs.tag,function(a,d,e){e=d.match(b.regs.tagName);e=e[0];for(var c in b.placeholders.$tags)if(e==b.placeholders.$tags[c])return B[c](d.replace(e,""));return a})},B={compare:function(a){a=this.compareSyntaxAnalysis(a,"??",2);var c=this.compareSyntaxAnalysis(a[1],"::",1),d="{",b;for(b in c)"function"!=typeof c[b]&&(1==b&&(d+="} else {"),d=-1!=c[b].indexOf("'")||-1!=c[b].indexOf('"')?d+(" var result = "+c[b]):d+(" var result = "+this.transVar(c[b])));d="if ("+this.transVar(a[0])+") "+d+"}";eval(d);return result||""},transVar:function(a){return a.replace(b.regs.jsvar,function(a,d){return z(d,null,!0)})},compareSyntaxAnalysis:function(a,c,d){a=a.split(c);if(a.length<d)throw Error('Syntax error: "'+b.placeholders.$tags.compare+'" expression is not legal');return a}},x=function(a,c){return a.replace(b.regs.$foreach,function(a,b,c){a=m("foreach","endforeach",a,!0,!0);var d;c=a.exp.split(" ");d=[];for(b=0;b<c.length;b++)c[b]&&"\n"!=c[b]&&d.push(c[b].replace(/[\s\n]/gi,""));c="";var e,f=null,g;e=d.shift();e=p(e);e=k(e)||[];1<d.length&&(f=d.shift());g=d.pop();for(b in e)"function"!=typeof e[b]&&(d=a.content,f&&w.assign(p(f),b),w.assign(p(g),e[b]),d=y(d),v("foreach",d)&&(d=x(d,"test")),c+=t(d),c=l(c));return c})},t=function(a,c){return a.replace(b.regs.$if,function(a,c,f){f=m("if","end",a);a=f.full;c=[];c.push(f.content);f=q("if",f,0);for(var d=g(b.placeholders.$elseif,a),e=1;e<=d;e++){var h=m("elseif","end",a);a=h.full;c.push(h.content);f+=q("elseif",h,e)}g(b.placeholders.$else,a)&&(h=m("else","end",a),h.full&&(a=h.full.replace(b.placeholders.$else,"")),c.push(h.content),f+=q("else",h,e));eval(f);a&&(a=a.replace(b.placeholders.$endif,""));return(l(c[key])||"")+a})},l=function(a,c,d,e){return a?a.replace(b.regs.$var,function(a,b,g){return z(b,c,d,e)}):null},z=function(a,c,d,e){return-1==a.indexOf("[")?d?'"'+k(a,c,e)+'"':k(a,c,e):k(a.replace(b.regs.stringVar,function(a,b){return"."+k(b,c,e)}),e)},k=function(a,c,d){c=c||b.vars;for(var e=a.split("."),f=0;f<e.length;f++)if("undefined"!=typeof c[e[f]])c=c[e[f]];else return"undefined"!=typeof d?d:b.delimiter.start+a+b.delimiter.end;return c}};